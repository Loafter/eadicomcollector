package main

import (
	"encoding/base64"
	"encoding/json"
	"errors"
	"io/ioutil"
	"log"
	"net/http"
	"strconv"
)

const htmlData = "PCFkb2N0eXBlIGh0bWw+DQoNCjxodG1sPg0KDQo8aGVhZD4NCiAgICA8dGl0bGU+RUEgZm9sZGVyIGNvbXByZXNzIHRvb2wgVUk8L3RpdGxlPg0KICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgiPg0KICAgIDxsaW5rIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0iaHR0cHM6Ly9uZXRkbmEuYm9vdHN0cmFwY2RuLmNvbS9ib290c3dhdGNoLzMuMC4wL3NsYXRlL2Jvb3RzdHJhcC5taW4uY3NzIj4NCiAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJodHRwczovL2FqYXguZ29vZ2xlYXBpcy5jb20vYWpheC9saWJzL2pxdWVyeS8yLjAuMy9qcXVlcnkubWluLmpzIj48L3NjcmlwdD4NCiAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJodHRwczovL25ldGRuYS5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjEuMS9qcy9ib290c3RyYXAubWluLmpzIj48L3NjcmlwdD4NCiAgICA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPg0KICAgICAgICBib2R5IHsNCiAgICAgICAgICAgIHBhZGRpbmctdG9wOiAyMHB4Ow0KICAgICAgICB9DQoNCiAgICAgICAgLmZvb3RlciB7DQogICAgICAgICAgICBib3JkZXItdG9wOiAxcHggc29saWQgI2VlZTsNCiAgICAgICAgICAgIG1hcmdpbi10b3A6IDQwcHg7DQogICAgICAgICAgICBwYWRkaW5nLXRvcDogNDBweDsNCiAgICAgICAgICAgIHBhZGRpbmctYm90dG9tOiA0MHB4Ow0KICAgICAgICB9DQogICAgICAgIC8qIE1haW4gbWFya2V0aW5nIG1lc3NhZ2UgYW5kIHNpZ24gdXAgYnV0dG9uICovDQoNCiAgICAgICAgLmp1bWJvdHJvbiB7DQogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsNCiAgICAgICAgfQ0KDQogICAgICAgIC5qdW1ib3Ryb24gLmJ0biB7DQogICAgICAgICAgICBmb250LXNpemU6IDIxcHg7DQogICAgICAgICAgICBwYWRkaW5nOiAxNHB4IDI0cHg7DQogICAgICAgIH0NCiAgICAgICAgLyogQ3VzdG9taXplIHRoZSBuYXYtanVzdGlmaWVkIGxpbmtzIHRvIGJlIGZpbGwgdGhlIGVudGlyZSBzcGFjZSBvZiB0aGUgLm5hdmJhciAqLw0KDQogICAgICAgIC5uYXYtanVzdGlmaWVkIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICNlZWU7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7DQogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjY2NjOw0KICAgICAgICB9DQoNCiAgICAgICAgLm5hdi1qdXN0aWZpZWQgPiBsaSA+IGEgew0KICAgICAgICAgICAgcGFkZGluZy10b3A6IDE1cHg7DQogICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTVweDsNCiAgICAgICAgICAgIGNvbG9yOiAjNzc3Ow0KICAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7DQogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogICAgICAgICAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgI2Q1ZDVkNTsNCiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICNlNWU1ZTU7DQogICAgICAgICAgICAvKiBPbGQgYnJvd3NlcnMgKi8NCiAgICAgICAgICAgIGJhY2tncm91bmQtcmVwZWF0OiByZXBlYXQteDsNCiAgICAgICAgICAgIC8qIFJlcGVhdCB0aGUgZ3JhZGllbnQgKi8NCiAgICAgICAgICAgIGJhY2tncm91bmQtaW1hZ2U6IC1tb3otbGluZWFyLWdyYWRpZW50KHRvcCwgI2Y1ZjVmNSAwJSwgI2U1ZTVlNSAxMDAlKTsNCiAgICAgICAgICAgIC8qIEZGMy42KyAqLw0KICAgICAgICAgICAgYmFja2dyb3VuZC1pbWFnZTogLXdlYmtpdC1ncmFkaWVudChsaW5lYXIsIGxlZnQgdG9wLCBsZWZ0IGJvdHRvbSwgY29sb3Itc3RvcCgwJSwgI2Y1ZjVmNSksIGNvbG9yLXN0b3AoMTAwJSwgI2U1ZTVlNSkpOw0KICAgICAgICAgICAgLyogQ2hyb21lLFNhZmFyaTQrICovDQogICAgICAgICAgICBiYWNrZ3JvdW5kLWltYWdlOiAtd2Via2l0LWxpbmVhci1ncmFkaWVudCh0b3AsICNmNWY1ZjUgMCUsICNlNWU1ZTUgMTAwJSk7DQogICAgICAgICAgICAvKiBDaHJvbWUgMTArLFNhZmFyaSA1LjErICovDQogICAgICAgICAgICBiYWNrZ3JvdW5kLWltYWdlOiAtbXMtbGluZWFyLWdyYWRpZW50KHRvcCwgI2Y1ZjVmNSAwJSwgI2U1ZTVlNSAxMDAlKTsNCiAgICAgICAgICAgIC8qIElFMTArICovDQogICAgICAgICAgICBiYWNrZ3JvdW5kLWltYWdlOiAtby1saW5lYXItZ3JhZGllbnQodG9wLCAjZjVmNWY1IDAlLCAjZTVlNWU1IDEwMCUpOw0KICAgICAgICAgICAgLyogT3BlcmEgMTEuMTArICovDQogICAgICAgICAgICBmaWx0ZXI6IHByb2dpZDogRFhJbWFnZVRyYW5zZm9ybS5NaWNyb3NvZnQuZ3JhZGllbnQoc3RhcnRDb2xvcnN0cj0nI2Y1ZjVmNScsIGVuZENvbG9yc3RyPScjZTVlNWU1JywgR3JhZGllbnRUeXBlPTApOw0KICAgICAgICAgICAgLyogSUU2LTkgKi8NCiAgICAgICAgICAgIGJhY2tncm91bmQtaW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0b3AsICNmNWY1ZjUgMCUsICNlNWU1ZTUgMTAwJSk7DQogICAgICAgICAgICAvKiBXM0MgKi8NCiAgICAgICAgfQ0KDQogICAgICAgIC5uYXYtanVzdGlmaWVkID4gLmFjdGl2ZSA+IGEsDQogICAgICAgIC5uYXYtanVzdGlmaWVkID4gLmFjdGl2ZSA+IGE6aG92ZXIsDQogICAgICAgIC5uYXYtanVzdGlmaWVkID4gLmFjdGl2ZSA+IGE6Zm9jdXMgew0KICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2RkZDsNCiAgICAgICAgICAgIGJhY2tncm91bmQtaW1hZ2U6IG5vbmU7DQogICAgICAgICAgICBib3gtc2hhZG93OiBpbnNldCAwIDNweCA3cHggcmdiYSgwLCAwLCAwLCAuMTUpOw0KICAgICAgICB9DQoNCiAgICAgICAgLm5hdi1qdXN0aWZpZWQgPiBsaTpmaXJzdC1jaGlsZCA+IGEgew0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4IDVweCAwIDA7DQogICAgICAgIH0NCg0KICAgICAgICAubmF2LWp1c3RpZmllZCA+IGxpOmxhc3QtY2hpbGQgPiBhIHsNCiAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDA7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAwIDAgNXB4IDVweDsNCiAgICAgICAgfQ0KDQogICAgICAgIEBtZWRpYShtaW4td2lkdGg6IDc2OHB4KSB7DQogICAgICAgICAgICAubmF2LWp1c3RpZmllZCB7DQogICAgICAgICAgICAgICAgbWF4LWhlaWdodDogNTJweDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIC5uYXYtanVzdGlmaWVkID4gbGkgPiBhIHsNCiAgICAgICAgICAgICAgICBib3JkZXItbGVmdDogMXB4IHNvbGlkICNmZmY7DQogICAgICAgICAgICAgICAgYm9yZGVyLXJpZ2h0OiAxcHggc29saWQgI2Q1ZDVkNTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIC5uYXYtanVzdGlmaWVkID4gbGk6Zmlyc3QtY2hpbGQgPiBhIHsNCiAgICAgICAgICAgICAgICBib3JkZXItbGVmdDogMDsNCiAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHggMCAwIDVweDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIC5uYXYtanVzdGlmaWVkID4gbGk6bGFzdC1jaGlsZCA+IGEgew0KICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDAgNXB4IDVweCAwOw0KICAgICAgICAgICAgICAgIGJvcmRlci1yaWdodDogMDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICAvKiBSZXNwb25zaXZlOiBQb3J0cmFpdCB0YWJsZXRzIGFuZCB1cCAqLw0KDQogICAgICAgIEBtZWRpYSBzY3JlZW4gYW5kKG1pbi13aWR0aDogNzY4cHgpIHsNCiAgICAgICAgICAgIC8qIFJlbW92ZSB0aGUgcGFkZGluZyB3ZSBzZXQgZWFybGllciAqLw0KICAgICAgICAgICAgLm1hc3RoZWFkLCAubWFya2V0aW5nLCAuZm9vdGVyIHsNCiAgICAgICAgICAgICAgICBwYWRkaW5nLWxlZnQ6IDA7DQogICAgICAgICAgICAgICAgcGFkZGluZy1yaWdodDogMDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIDwvc3R5bGU+DQogICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiPg0KICAgICAgICBmdW5jdGlvbiBzZW5kY29tcHRhc2soKSB7DQogICAgICAgICAgICB2YXIgcmVxID0gew0KICAgICAgICAgICAgICAgIEFyY2hQYXRoUHJlZml4OiAkKCIjYXJwcmVmaXgtaWQiKQ0KICAgICAgICAgICAgICAgICAgICAudmFsKCksDQogICAgICAgICAgICAgICAgRGF5OiAkKCIjZGF5LWlkIikNCiAgICAgICAgICAgICAgICAgICAgLnZhbCgpLA0KICAgICAgICAgICAgICAgIE1vbnRoOiAkKCIjbW91bnRoLWlkIikNCiAgICAgICAgICAgICAgICAgICAgLnZhbCgpLA0KICAgICAgICAgICAgICAgIFllYXI6ICQoIiN5ZWFyLWlkIikNCiAgICAgICAgICAgICAgICAgICAgLnZhbCgpLA0KICAgICAgICAgICAgICAgIFBpZDogJCgiI3BhdGllbnQtaWQiKQ0KICAgICAgICAgICAgICAgICAgICAudmFsKCksDQogICAgICAgICAgICAgICAgT3V0cHV0RGlyOiAkKCIjb3V0cHV0ZGlyLWlkIikNCiAgICAgICAgICAgICAgICAgICAgLnZhbCgpLA0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICQuYWpheCh7DQogICAgICAgICAgICAgICAgICAgIHVybDogIi9jb21wcmVzcyIsDQogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJQT1NUIiwNCiAgICAgICAgICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkocmVxKSwNCiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIg0KICAgICAgICAgICAgICAgIH0pDQogICAgICAgICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24oanNvbkRhdGEpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGluZXJIdG1sID0gIiINCiAgICAgICAgICAgICAgICAgICAgaW5lckh0bWwgPSBpbmVySHRtbC5jb25jYXQoJzxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmcgYWxlcnQtZGlzbWlzc2FibGUiPjxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0iY2xvc2UiIGRhdGEtZGlzbWlzcz0iYWxlcnQiPiZ0aW1lczs8L2J1dHRvbj48Yj5Db21wcmVzcyBzZXJ2ZXIgcmVzcG9uc2U8L2I+ICcpDQogICAgICAgICAgICAgICAgICAgIGluZXJIdG1sID0gaW5lckh0bWwuY29uY2F0KCc8YSBocmVmPSInICsgJ2h0dHA6Ly9sb2NhbGhvc3QvJyArIGpzb25EYXRhLkd1aWQgKyAnLnppcCI+JyArICdodHRwOi8vbG9jYWxob3N0LycgKyBqc29uRGF0YS5HdWlkICsgJy56aXA8L2E+JykNCiAgICAgICAgICAgICAgICAgICAgaW5lckh0bWwgPSBpbmVySHRtbC5jb25jYXQoJyA8L2Rpdj4nKQ0KICAgICAgICAgICAgICAgICAgICAkKCIjd2VsbC1pZCIpDQogICAgICAgICAgICAgICAgICAgICAgICAuYXBwZW5kKGluZXJIdG1sKQ0KICAgICAgICAgICAgICAgIH0pDQogICAgICAgICAgICAgICAgLmVycm9yKGZ1bmN0aW9uKGpzb25EYXRhKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBpbmVySHRtbCA9ICIiDQogICAgICAgICAgICAgICAgICAgIGluZXJIdG1sID0gaW5lckh0bWwuY29uY2F0KCc8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIGFsZXJ0LWRpc21pc3NhYmxlIj48YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImNsb3NlIiBkYXRhLWRpc21pc3M9ImFsZXJ0Ij4mdGltZXM7PC9idXR0b24+PHA+Q29ubmV0aW9uIGVycm9yPC9wPiAnKQ0KICAgICAgICAgICAgICAgICAgICBpbmVySHRtbCA9IGluZXJIdG1sLmNvbmNhdChKU09OLnN0cmluZ2lmeShqc29uRGF0YSkpDQogICAgICAgICAgICAgICAgICAgIGluZXJIdG1sID0gaW5lckh0bWwuY29uY2F0KCcgPC9kaXY+JykNCiAgICAgICAgICAgICAgICAgICAgJCgiI3dlbGwtaWQiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgLmFwcGVuZChpbmVySHRtbCkNCiAgICAgICAgICAgICAgICB9KQ0KICAgICAgICB9DQogICAgPC9zY3JpcHQ+DQo8L2hlYWQ+DQoNCjxib2R5Pg0KICAgIDxkaXYgY2xhc3M9ImNvbnRhaW5lciI+DQogICAgICAgIDxkaXYgY2xhc3M9IndlbGwiIGlkPSJ3ZWxsLWlkIj4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9InBhbmVsLWZvb3RlciI+RUEgQXJjaGl2ZSBTZXJ2aWNlPC9kaXY+DQogICAgICAgICAgICA8dGFibGUgY2xhc3M9InRhYmxlIHRhYmxlLWJvcmRlcmVkIHRhYmxlLWNvbmRlbnNlZCB0YWJsZS1ob3ZlciB0YWJsZS1zdHJpcGVkIj4NCiAgICAgICAgICAgICAgICA8dGJvZHk+DQogICAgICAgICAgICAgICAgICAgIDx0cj4NCiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJjb250cm9sLWxhYmVsIj5BcmhpdmUgcHJlZml4PC9sYWJlbD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udHJvbHMiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSJmb3JtLWNvbnRyb2wgaW5wdXQtc20iIGlkPSJhcnByZWZpeC1pZCIgdmFsdWU9IkU6XEFyY2hpdmVcQVJDSDFcTElCX0VcSW5jb21pbmciIHR5cGU9InRleHQiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwvdGQ+DQogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+U3R1ZHkgZGF5PC9sYWJlbD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udHJvbHMiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSJmb3JtLWNvbnRyb2wgaW5wdXQtc20iIGlkPSJkYXktaWQiIHZhbHVlPSIwMSIgdHlwZT0idGV4dCI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgPC90ZD4NCg0KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPlN0dWR5IG1vdW50aDwvbGFiZWw+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2xzIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0iZm9ybS1jb250cm9sIGlucHV0LXNtIiBpZD0ibW91bnRoLWlkIiB2YWx1ZT0iMDQiIHR5cGU9InRleHQiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwvdGQ+DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJjb250cm9sLWxhYmVsIj5TdHVkeSBZZWFyPC9sYWJlbD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udHJvbHMiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSJmb3JtLWNvbnRyb2wgaW5wdXQtc20iIGlkPSJ5ZWFyLWlkIiB2YWx1ZT0iMjAwMSIgdHlwZT0idGV4dCI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgPC90ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJjb250cm9sLWxhYmVsIj5QYXRpZW50IGlkPC9sYWJlbD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udHJvbHMiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSJmb3JtLWNvbnRyb2wgaW5wdXQtc20iIGlkPSJwYXRpZW50LWlkIiB2YWx1ZT0iSUQwMDEiIHR5cGU9InRleHQiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwvdGQ+DQogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+T3V0cHV0IGRpcjwvbGFiZWw+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2xzIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0iZm9ybS1jb250cm9sIGlucHV0LXNtIiBpZD0ib3V0cHV0ZGlyLWlkIiB2YWx1ZT0iRTpcRGljb21XZWJTZXJ2ZXJDYWNoZSIgdHlwZT0idGV4dCI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgPC90ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJjb250cm9sLWxhYmVsIj48L2xhYmVsPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250cm9scyI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YSBvbmNsaWNrPSJzZW5kY29tcHRhc2soKSIgY2xhc3M9ImJ0biBidG4taW5mbyI+UyBFIE4gRDwvYT4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgICAgICAgICAgICA8L3RkPg0KICAgICAgICAgICAgICAgICAgICA8L3RyPg0KICAgICAgICAgICAgICAgIDwvdGJvZHk+DQogICAgICAgICAgICA8L3RhYmxlPg0KICAgICAgICA8L2Rpdj4NCiAgICA8L2Rpdj4NCjwvYm9keT4NCg0KPC9odG1sPg0K"

//main srv class
type EaFolderCompressorSrv struct {
	fcom FolderCompressor
}

//start and init srv
func (srv *EaFolderCompressorSrv) Start(listenPort int) error {
	http.HandleFunc("/compress", srv.Compress)
	http.HandleFunc("/", srv.Redirect)
	http.HandleFunc("/index.html", srv.index)
	if err := http.ListenAndServe(":"+strconv.Itoa(listenPort), nil); err != nil {
		return errors.New("error: can't start listen http server")
	}
	return nil
}

//serve main page request
func (srv *EaFolderCompressorSrv) index(rwr http.ResponseWriter, req *http.Request) {
	rwr.Header().Set("Content-Type: text/html", "*")

	content, err := ioutil.ReadFile("index.html")
	if err != nil {
		log.Println("warning: start page not found, return included page")
		val, _ := base64.StdEncoding.DecodeString(htmlData)
		rwr.Write(val)
		return
	}
	rwr.Write(content)
}

func (service *EaFolderCompressorSrv) Redirect(responseWriter http.ResponseWriter, request *http.Request) {
	http.Redirect(responseWriter, request, "/index.html", 301)
}

//serve cEcho responce
func (srv *EaFolderCompressorSrv) Compress(rwr http.ResponseWriter, httpreq *http.Request) {
	defer httpreq.Body.Close()
	bodyData, err := ioutil.ReadAll(httpreq.Body)
	if err != nil {
		strErr := "error: Can't read http body data"
		http.Error(rwr, err.Error(), http.StatusInternalServerError)
		log.Println(strErr)
		return
	}
	//parse http request
	var req EaCompRequest
	if err := json.Unmarshal(bodyData, &req); err != nil {
		strErr := "error: can't parse request data"
		http.Error(rwr, err.Error(), http.StatusInternalServerError)
		log.Println(strErr)
		return
	}

	TgF := req.ArchPathPrefix + "\\" + req.Year + "\\" + req.Month + "\\" + req.Day + "\\" + req.Pid
	NHash := req.Year + req.Month + req.Day + req.Pid
	ResF := req.OutputDir + "\\" + NHash + ".zip"

	log.Println("info: try compress file ", "7z.exe", "a", "-tzip", TgF, ResF)
	err = srv.fcom.CompressFolder("7z.exe", "a", "-tzip", TgF, ResF)
	if err != nil {
		log.Println(err)
		http.Error(rwr, err.Error(), http.StatusInternalServerError)
		return

	}
	res := EaCompResponse{Guid: NHash}
	js, err := json.Marshal(res)
	if err != nil {
		http.Error(rwr, err.Error(), http.StatusInternalServerError)
		return
	}
	rwr.Header().Set("Content-Type", "application/json")
	rwr.Write(js)
}
